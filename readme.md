# ETF 监控工具 - 产品架构文档

## 产品概述

### 目标
- 监控自选 ETF（如"医疗 ETF"）的实时价格、涨跌幅和成交量。
- 将最新行情固定展示在 Windows 系统托盘，通过 Tooltip 轮播显示多个基金。
- 实现独立的 Windows 应用（安装包 + 托盘图标 + 开机自启选项）。
- 确保数据来源可靠、延迟低，同时保持较小的内存和 CPU 占用。

### 核心特性
- **动态轮播**：在托盘图标 Tooltip 中轮流显示自选 ETF 行情
- **智能刷新**：支持定时轮播或价格变化时触发轮播
- **灵活配置**：通过设置界面管理 ETF 列表、刷新间隔、轮播间隔
- **可靠数据源**：采用东方财富接口，配置主备接口自动切换
- **开箱即用**：提供完整的 Windows 安装包，支持开机自启

### 实施步骤
1. **数据源选择**  
   - 选用公开行情接口（东方财富、腾讯行情、Sina 等）获取 JSON/CSV 数据。  
   - `fetch_price(etf_code)` 增加异常处理、超时重试、节流（例如 3~5 秒刷新间隔）。  
   - 配置主备接口，接口不可用时自动切换，保证数据连续性。

2. **后台服务**  
   - 使用 Python + `asyncio`/`httpx` 等协程方式轮询多只 ETF，降低阻塞。  
   - 将最新行情写入内存缓存或轻量消息队列，供 UI 订阅。  
   - 通过日志记录接口耗时、失败次数，为后续优化提供依据。

3. **托盘 / 浮窗展示**  
   - 采用 `pystray` 实现托盘图标与 tooltip，实时展示 `ETF 名称 / 最新价 / 涨跌幅`。  
   - 若需要更显眼的视觉效果，可结合 `PyQt5` / `Tkinter` / `pywebview` 创建透明无边框窗口，固定在右下角。  
   - UI 仅在数据变化时刷新文本和颜色，减少重绘开销。

4. **交互与配置**  
   - 托盘菜单提供暂停刷新、刷新频率切换、打开配置、退出等入口。  
   - `config.yaml`/`settings.json` 保存 ETF 代码、刷新频率、颜色阈值等。  
   - 支持不同涨跌幅阈值的颜色提示（上涨为绿色、下跌为红色），并可设置提醒音/Toast。

5. **Windows 应用打包与发布**  
   - 使用 `pyinstaller`、`cx_Freeze` 或 `nuitka` 打包生成单独的 `.exe`，内嵌图标与资源。  
   - 借助 `Inno Setup`、`NSIS` 或 `MSIX Packaging Tool` 制作安装包，提供开机自启、开始菜单快捷方式。  
   - 如需更原生的体验，可考虑使用 WPF（C#）或 WinUI 重写界面，通过内嵌 Python/HTTP 服务或直接调用行情 SDK。

### 实时性与准确性保障
- 定期对比主备数据源，超过阈值时记录告警并切换。  
- 返回数据附带时间戳、成交量等字段，确保展示的是最新成交价。  
- 网络链路监控：请求超时或 HTTP 状态异常时快速重试，超过阈值后退避。  
- 在托盘 tooltip 中展示最近更新时间，方便人工快速判断数据是否停滞。

### 资源占用优化
- 使用异步 I/O、轻量线程池，避免 UI 线程阻塞；刷新频率根据接口 SLA 动态调整。  
- 关闭多余的调试日志，按天轮转，防止日志无限增长。  
- 通过 `psutil` 或 PerfMon 做基准测试，目标常驻内存 < 100MB、CPU 峰值 < 5%。  
- 发布前使用 `py-spy` 或 Windows Performance Recorder 找出瓶颈函数进行优化。

### 市面参考工具
- 东方财富桌面端、同花顺 PC 版：提供托盘行情和提醒功能，可借鉴交互设计。  
- TradingView Desktop + 小组件：支持自定义行情小窗，参考其实时刷新逻辑。  
- Rainmeter 股票皮肤：利用轻量桌面组件展示行情，值得学习资源占用控制方法。

### 后续迭代方向
- 接入 WebSocket 或行情推送，进一步降低延迟。  
- 加入阈值告警（语音播报、桌面通知、邮件/微信推送）。  
- 缓存历史数据绘制迷你趋势图或导出 CSV，方便复盘。  
- 结合账号体系，在多台设备之间同步自选 ETF 列表与配置。

---

## 产品架构设计

### 1. 系统架构概览

本应用采用基于 **wxPython** 的桌面应用架构，使用多线程模式确保 UI 响应性和数据实时性。

#### 架构层次
```
┌─────────────────────────────────────────────┐
│           展示层（UI Layer）                 │
│  - 系统托盘图标 + Tooltip 轮播显示           │
│  - 设置对话框（ETF 管理 + 参数配置）         │
│  - 详情窗口（可选，显示所有 ETF 列表）       │
└─────────────────┬───────────────────────────┘
                  │ wxPython 事件机制
┌─────────────────▼───────────────────────────┐
│         业务逻辑层（Logic Layer）            │
│  - 轮播控制器（定时/变化触发）               │
│  - 配置管理器（读写 config.json）            │
│  - 数据缓存管理器（内存缓存 + 变化检测）     │
└─────────────────┬───────────────────────────┘
                  │ Python Queue
┌─────────────────▼───────────────────────────┐
│         数据层（Data Layer）                 │
│  - HTTP 客户端（httpx 异步请求）             │
│  - 接口适配器（东方财富/腾讯/新浪）          │
│  - 主备切换逻辑                              │
└─────────────────────────────────────────────┘
```

#### 线程模型
- **主线程（UI Thread）**
  - 运行 wxPython 事件循环
  - 处理用户交互（托盘菜单、设置界面）
  - 更新托盘 Tooltip 显示
  
- **数据采集线程（Fetcher Thread）**
  - 定时轮询行情接口（默认 5 秒）
  - 并发请求多个 ETF 数据
  - 处理网络异常和重试
  
- **轮播控制线程（Rotator Thread）**
  - 监听数据变化事件
  - 控制 Tooltip 轮播时机
  - 管理轮播队列

#### 线程间通信
- 使用 **Python Queue** 传递行情数据
- 使用 **wxPython 自定义事件** 通知 UI 更新
- 使用 **threading.Event** 控制线程启停

### 2. 技术选型说明

#### 核心技术栈
| 组件 | 技术选型 | 选型理由 |
|------|---------|---------|
| UI 框架 | wxPython | 原生 Windows 外观，资源占用适中（40-60MB），成熟稳定 |
| HTTP 客户端 | httpx | 支持同步/异步，连接池，超时控制，现代化 API |
| 配置管理 | JSON 文件 | 简单易读，支持手动编辑，无额外依赖 |
| 日志框架 | Python logging | 标准库，按天轮转，分级记录 |
| 打包工具 | PyInstaller | 成熟稳定，支持单文件/单目录，资源嵌入方便 |
| 安装包 | Inno Setup | 功能强大，支持注册表操作，脚本灵活 |

#### 为什么选择 wxPython 而非其他框架
- **vs PyQt5/PyQt6**：无 GPL 许可证限制，打包体积更小，原生外观更好
- **vs Tkinter**：界面更现代美观，控件更丰富，托盘支持更完善
- **vs Electron**：资源占用低得多（60MB vs 150MB+），启动速度快

### 3. 数据源设计

#### 东方财富接口方案

##### 接口地址
```
主接口：http://push2.eastmoney.com/api/qt/stock/get
备用接口 1：http://qt.gtimg.cn/q= (腾讯)
备用接口 2：http://hq.sinajs.cn/list= (新浪)
```

##### 请求示例
```
GET http://push2.eastmoney.com/api/qt/stock/get?
  secid=1.512170&
  fields=f57,f58,f43,f44,f45,f46,f60,f152
```

##### 字段说明
- `f57`: 基金代码
- `f58`: 基金名称  
- `f43`: 最新价
- `f44`: 涨跌额
- `f45`: 涨跌幅（%）
- `f46`: 成交量
- `f60`: 昨收价
- `f152`: 数据更新时间

##### 返回数据结构
```json
{
  "rc": 0,
  "data": {
    "f57": "512170",
    "f58": "医疗ETF",
    "f43": 1.234,
    "f44": 0.028,
    "f45": 2.32,
    "f46": 12345678,
    "f60": 1.206,
    "f152": "20231104143000"
  }
}
```

##### 主备切换策略
1. **切换触发条件**
   - 主接口连续失败 3 次
   - 单次请求超时（> 5 秒）
   - HTTP 状态码异常（非 200）

2. **切换流程**
   - 记录切换日志（WARNING 级别）
   - 更新内部接口状态标记
   - 使用备用接口继续请求
   - 每 5 分钟尝试切回主接口

3. **数据一致性校验**
   - 对比主备接口价格差异
   - 差异超过 1% 时记录告警
   - 优先使用时间戳更新的数据

#### 数据模型定义

##### ETFQuote 数据结构
```python
{
  "code": "512170",              # 基金代码
  "name": "医疗ETF",              # 基金名称
  "price": 1.234,                # 最新价
  "change": 0.028,               # 涨跌额
  "change_percent": 2.32,        # 涨跌幅(%)
  "volume": 12345678,            # 成交量
  "pre_close": 1.206,            # 昨收价
  "update_time": "14:30:00",     # 更新时间
  "timestamp": 1699084200        # Unix 时间戳
}
```

##### ETFCache 缓存结构
```python
{
  "512170": {
    "data": ETFQuote,            # 最新行情数据
    "prev_data": ETFQuote,       # 上次行情数据
    "changed": True,             # 是否有变化
    "last_update": 1699084200,   # 最后更新时间戳
    "error_count": 0             # 连续失败次数
  }
}
```

### 4. 核心功能模块详解

#### 4.1 配置管理模块

##### 配置文件结构（config.json）
参见 `docs/config_schema.md` 获取完整的配置文件说明。

核心配置项：
- `etf_list`: 自选 ETF 代码列表
- `refresh_interval`: 数据刷新间隔（秒）
- `rotation_interval`: 托盘轮播间隔（秒）
- `rotation_mode`: 轮播模式（timer/change/both）
- `api_config`: 接口配置（主备地址、超时设置）
- `alert_threshold`: 告警阈值
- `auto_start`: 开机自启

##### 配置管理器职责
1. **加载配置**
   - 启动时读取 config.json
   - 验证配置项完整性和合法性
   - 提供默认值填充缺失项

2. **保存配置**
   - 格式化 JSON 输出（缩进 2 空格）
   - 原子性写入（写临时文件后重命名）
   - 保存前进行数据验证

3. **配置监听**
   - 监听文件变化（可选功能）
   - 热重载配置（无需重启）
   - 通知相关模块配置已更新

#### 4.2 设置界面模块

##### 界面布局设计
```
┌─────────────────────────────────────────┐
│  ETF 监控工具 - 设置                    │
├─────────────────────────────────────────┤
│  【我的自选 ETF】                        │
│  ┌───────────────────────────────────┐  │
│  │ 代码      名称          最新价     │  │
│  │ 512170   医疗ETF        1.234     │  │
│  │ 159928   消费ETF        2.567     │  │
│  │ ...                              │  │
│  └───────────────────────────────────┘  │
│                                         │
│  添加新 ETF：                            │
│  ┌────────────┐  [添加] [删除] [清空]  │
│  │ 输入代码   │                         │
│  └────────────┘                         │
│                                         │
│  【刷新设置】                            │
│  数据刷新间隔：[ 5 秒 ] ▬▬●▬▬ (3-30秒)  │
│  托盘轮播间隔：[ 3 秒 ] ▬▬●▬▬ (1-60秒)  │
│                                         │
│  轮播模式：                              │
│  ○ 定时轮播  ○ 价格变化时  ● 两者都     │
│                                         │
│  其他选项：                              │
│  ☑ 开机自动启动                         │
│  ☐ 启用告警提示                         │
│                                         │
│         [保存]  [取消]  [恢复默认]       │
└─────────────────────────────────────────┘
```

##### 交互流程

**新增 ETF 完整流程**：
1. 用户在输入框输入基金代码（如 512170）
2. 点击"添加"按钮
3. 前端验证代码格式（6 位数字）
4. 调用接口获取基金名称（验证代码有效性）
5. 添加到列表控件（代码、名称、当前价格）
6. 用户点击"保存"
7. 写入 config.json
8. 触发 ConfigChanged 事件
9. 数据采集线程重新加载 ETF 列表
10. 开始采集新增 ETF 的行情

**删除 ETF 流程**：
1. 用户在列表中选中一个或多个 ETF
2. 点击"删除"按钮
3. 确认对话框（可选）
4. 从列表控件移除
5. 点击"保存"
6. 更新 config.json
7. 数据采集线程停止采集已删除的 ETF

**参数调整流程**：
1. 用户拖动滑块调整刷新间隔
2. 实时显示当前数值
3. 选择轮播模式单选框
4. 点击"保存"
5. 更新配置文件
6. 采集线程和轮播线程读取新参数
7. 按新参数运行

#### 4.3 数据采集模块

##### 采集流程详解

```
[定时器触发（每 5 秒）]
         ↓
[读取 ETF 列表从配置]
         ↓
[创建请求任务队列]
         ↓
[并发发送 HTTP 请求] ──→ [请求超时?] ──Yes→ [重试（最多3次）]
         ↓ No                              ↓ 仍失败
[解析 JSON 响应]                        [记录错误日志]
         ↓                                  ↓
[提取关键字段]                          [切换备用接口]
         ↓                                  ↓
[与缓存数据对比]                        [继续尝试]
         ↓
[检测价格/涨跌幅变化]
         ↓
[更新内存缓存]
         ↓
[变化?] ──Yes→ [设置 changed=True] ──→ [发送 DataChanged 事件]
  ↓ No
[更新时间戳]
  ↓
[等待下次触发]
```

##### 并发请求策略
```python
# 伪代码示例
使用线程池（ThreadPoolExecutor）:
  pool_size = min(len(etf_list), 10)  # 最多10个并发
  
  for etf_code in etf_list:
    submit_task(fetch_quote, etf_code)
  
  wait_all_tasks_complete(timeout=10秒)
  
  合并结果到缓存
```

##### 异常处理策略

| 异常类型 | 处理方式 | 影响 |
|---------|---------|------|
| 网络超时 | 重试 3 次，间隔 1 秒 | 单个 ETF 数据可能延迟 |
| HTTP 4xx | 记录错误，跳过本次 | 该 ETF 本次不更新 |
| HTTP 5xx | 切换备用接口 | 全部 ETF 切换接口 |
| JSON 解析失败 | 使用上次缓存数据 | 显示可能略有延迟 |
| 连续失败 5 次 | 暂停该 ETF 采集 10 分钟 | 避免持续请求无效接口 |

#### 4.4 系统托盘模块

##### 托盘图标设计
- **图标尺寸**：16x16（标准）、32x32（高 DPI）
- **图标样式**：简洁的股票曲线图标
- **动态效果**（可选）：
  - 整体上涨：绿色边框
  - 整体下跌：红色边框
  - 涨跌混合：默认颜色

##### Tooltip 轮播逻辑

**轮播模式详解**：

1. **定时轮播（Timer Mode）**
   - 每隔 `rotation_interval` 秒切换到下一个 ETF
   - 循环遍历 ETF 列表
   - 适合想定期查看所有持仓的用户

2. **变化触发（Change Mode）**
   - 当任一 ETF 价格变化时，立即切换到该 ETF
   - 保持显示该 ETF 直到下一个变化发生
   - 适合关注价格波动的用户

3. **混合模式（Both Mode）**（推荐）
   - 价格变化优先：有 ETF 变化时立即显示
   - 无变化时：按定时轮播继续
   - 最佳用户体验

##### Tooltip 显示格式

**标准格式**：
```
医疗ETF (512170)
最新价: 1.234 (↑2.35%)
更新: 14:32:05
```

**颜色方案**：
- 上涨：绿色文字 `[+2.35%]`
- 下跌：红色文字 `[-1.23%]`
- 平盘：灰色文字 `[0.00%]`

**特殊状态**：
```
正在获取数据...
───────────
上次更新: 14:30:00
```

##### 托盘右键菜单

```
┌─────────────────────────┐
│ ● 查看所有基金           │
│ ─────────────────────── │
│   设置...               │
│   手动刷新              │
│ ─────────────────────── │
│ ☑ 暂停刷新              │
│ ☑ 开机自启              │
│ ─────────────────────── │
│   关于                  │
│   退出                  │
└─────────────────────────┘
```

**菜单项功能**：
- **查看所有基金**：打开详情窗口，显示完整列表
- **设置**：打开设置对话框
- **手动刷新**：立即触发一次数据采集
- **暂停刷新**：切换开关，暂停/继续数据采集
- **开机自启**：切换开关，写入/删除注册表项
- **关于**：显示版本信息、开发者信息
- **退出**：关闭程序（可选：最小化到托盘提示）

#### 4.5 详情窗口（可选）

虽然主要通过托盘 Tooltip 展示，但提供详情窗口可以同时查看所有 ETF。

##### 窗口布局
```
┌───────────────────────────────────────────────────┐
│  ETF 监控 - 实时行情                    [_][□][×] │
├───────────────────────────────────────────────────┤
│  最后更新: 2023-11-04 14:32:05      [手动刷新]   │
├───────────────────────────────────────────────────┤
│  代码    ▼│ 名称    │  最新价  │ 涨跌幅  │ 成交量  │
├──────────┼─────────┼─────────┼────────┼─────────┤
│  512170  │ 医疗ETF  │  1.234  │ +2.35% │  1.2亿  │
│  159928  │ 消费ETF  │  2.567  │ -0.82% │  0.8亿  │
│  512480  │ 半导体   │  3.890  │ +5.12% │  2.5亿  │
│  ...     │  ...    │  ...    │  ...   │  ...    │
└───────────────────────────────────────────────────┘
```

##### 功能特性
- **实时更新**：数据变化时自动刷新表格
- **排序功能**：点击列头按涨跌幅、代码、名称排序
- **颜色标识**：上涨行背景浅绿色，下跌行背景浅红色
- **双击行为**：双击某行可查看该 ETF 详细信息（未来扩展）
- **最小化**：关闭窗口时最小化到托盘而非退出

### 5. 数据流转设计

#### 启动流程
```
[程序启动]
    ↓
[检查单实例]（避免重复运行）
    ↓
[加载配置文件] ──→ [配置不存在?] ──Yes→ [创建默认配置]
    ↓ No
[初始化日志系统]
    ↓
[创建系统托盘图标]
    ↓
[启动数据采集线程]
    ↓
[启动轮播控制线程]
    ↓
[进入 wxPython 主循环]
    ↓
[等待事件...]
```

#### 数据采集流程
```
[采集线程启动]
    ↓
[while 程序运行中:]
    ↓
  [等待刷新间隔]
    ↓
  [读取 ETF 列表]
    ↓
  [并发请求所有 ETF]
    ↓
  [for each ETF:]
      ↓
    [HTTP GET 请求] ──→ [成功?] ──No→ [重试逻辑] ──→ [仍失败] ──→ [记录错误]
      ↓ Yes                                              ↓
    [解析 JSON]                                      [使用缓存数据]
      ↓
    [提取数据字段]
      ↓
    [与缓存对比]
      ↓
    [价格变化?] ──Yes→ [标记 changed=True]
      ↓ No               ↓
    [更新缓存]      [发送 DataChanged 事件]
      ↓
  [end for]
    ↓
[end while]
```

#### 轮播控制流程
```
[轮播线程启动]
    ↓
[初始化轮播索引 = 0]
    ↓
[while 程序运行中:]
    ↓
  [检查轮播模式]
    ↓
  [模式 = Both/Change?]
      ↓ Yes
    [等待 DataChanged 事件（非阻塞）]
      ↓
    [有变化?] ──Yes→ [切换到变化的 ETF]
      ↓ No              ↓
    [超时继续]      [更新托盘 Tooltip]
      ↓                 ↓
    [定时器到期?]   [重置定时器]
      ↓ Yes
    [索引++，循环]
      ↓
    [更新托盘 Tooltip]
      ↓
  [等待轮播间隔]
    ↓
[end while]
```

#### 事件驱动机制

**自定义事件类型**：
1. **DataChangedEvent**：某个 ETF 数据发生变化
2. **ConfigChangedEvent**：配置文件被修改
3. **RefreshEvent**：手动刷新触发
4. **ErrorEvent**：网络或数据错误

**事件处理流程**：
```
[数据采集线程] ──→ [检测到价格变化]
                        ↓
                  [创建 DataChangedEvent]
                        ↓
                  [wx.PostEvent(主线程)]
                        ↓
                  [主线程事件循环接收]
                        ↓
                  [调用事件处理器]
                        ↓
                  [更新 UI / 触发轮播]
```

### 6. 打包与发布方案

#### 6.1 PyInstaller 打包配置

##### 打包模式选择
- **单文件模式**（推荐新用户）
  - 优点：分发简单，只有一个 .exe
  - 缺点：启动稍慢（需解压到临时目录）
  - 体积：约 50-70MB

- **单目录模式**（推荐高级用户）
  - 优点：启动快，便于调试
  - 缺点：文件较多，需整个目录分发
  - 体积：约 60-80MB（展开后）

##### PyInstaller 命令示例
```bash
pyinstaller --name="ETFMonitor" \
  --onefile \
  --noconsole \
  --icon="resources/icon.ico" \
  --add-data="resources;resources" \
  --add-data="config.default.json;." \
  --hidden-import=wx \
  --hidden-import=httpx \
  main.py
```

##### 优化打包体积
- 排除不必要的库：`--exclude-module tkinter`
- 压缩 UPX：`--upx-dir=/path/to/upx`
- 仅包含必要的 wxPython 组件

##### 资源文件管理
```
resources/
  ├── icons/
  │   ├── app.ico          # 应用图标
  │   ├── tray.ico         # 托盘图标
  │   ├── tray_up.ico      # 上涨图标（可选）
  │   └── tray_down.ico    # 下跌图标（可选）
  ├── config.default.json  # 默认配置模板
  └── LICENSE.txt          # 许可证文件
```

#### 6.2 Inno Setup 安装包

##### 安装包功能清单
- [x] 安装到 Program Files
- [x] 创建开始菜单快捷方式
- [x] 创建桌面快捷方式（可选）
- [x] 开机自启动选项
- [x] 卸载程序
- [x] 用户协议页面
- [x] 自定义安装路径

##### Inno Setup 脚本结构
```ini
[Setup]
AppName=ETF 监控工具
AppVersion=1.0.0
DefaultDirName={pf}\ETF Monitor
DefaultGroupName=ETF Monitor
OutputDir=output
OutputBaseFilename=ETFMonitor_Setup_v1.0.0

[Files]
Source: "dist\ETFMonitor.exe"; DestDir: "{app}"
Source: "resources\*"; DestDir: "{app}\resources"; Flags: recursesubdirs

[Icons]
Name: "{group}\ETF 监控"; Filename: "{app}\ETFMonitor.exe"
Name: "{commondesktop}\ETF 监控"; Filename: "{app}\ETFMonitor.exe"; Tasks: desktopicon

[Tasks]
Name: "desktopicon"; Description: "创建桌面快捷方式"; GroupDescription: "附加选项:"
Name: "autostart"; Description: "开机自动启动"; GroupDescription: "附加选项:"

[Registry]
; 开机自启动注册表项
Root: HKCU; Subkey: "Software\Microsoft\Windows\CurrentVersion\Run"; \
  ValueType: string; ValueName: "ETFMonitor"; ValueData: "{app}\ETFMonitor.exe"; \
  Flags: uninsdeletevalue; Tasks: autostart

[Run]
Filename: "{app}\ETFMonitor.exe"; Description: "启动 ETF 监控"; Flags: nowait postinstall skipifsilent
```

##### 安装后目录结构
```
C:\Program Files\ETF Monitor\
  ├── ETFMonitor.exe          # 主程序
  ├── config.json             # 用户配置（首次运行时创建）
  ├── resources/              # 资源目录
  │   ├── icons/
  │   └── config.default.json
  ├── logs/                   # 日志目录（运行时创建）
  │   └── etf_monitor.log
  └── unins000.exe            # 卸载程序
```

##### 卸载逻辑
- 删除程序文件
- 删除开始菜单快捷方式
- 删除注册表项（开机自启）
- **保留用户配置**（可选）：弹窗询问是否删除 config.json
- 删除日志文件（可选）

#### 6.3 版本管理与更新

##### 版本号规范
采用语义化版本：`主版本.次版本.修订号`
- 主版本：不兼容的 API 修改
- 次版本：新增功能，向下兼容
- 修订号：问题修复

##### 版本信息嵌入
```python
# version.py
VERSION = "1.0.0"
BUILD_DATE = "2023-11-04"
APP_NAME = "ETF 监控工具"
```

在 PyInstaller 中嵌入文件属性：
```python
# version_info.txt (Windows)
VSVersionInfo(
  ffi=FixedFileInfo(
    filevers=(1, 0, 0, 0),
    prodvers=(1, 0, 0, 0),
    ...
  ),
  kids=[
    StringFileInfo([
      StringTable('040904B0', [
        StringStruct('CompanyName', '个人开发'),
        StringStruct('FileDescription', 'ETF 监控工具'),
        StringStruct('FileVersion', '1.0.0'),
        StringStruct('ProductName', 'ETF Monitor'),
        StringStruct('ProductVersion', '1.0.0')
      ])
    ])
  ]
)
```

##### 配置文件版本兼容
```json
{
  "config_version": "1.0",
  "etf_list": [...],
  ...
}
```

启动时检查：
```python
if config["config_version"] < "1.0":
    migrate_config_to_v1()
```

### 7. 性能与优化

#### 7.1 资源占用目标

| 指标 | 目标值 | 测试方法 |
|------|--------|---------|
| 常驻内存 | < 80MB | Windows 任务管理器 |
| CPU 平均 | < 3% | 运行 1 小时平均值 |
| CPU 峰值 | < 10% | 数据刷新瞬间 |
| 启动时间 | < 3 秒 | 从点击到托盘图标出现 |
| 网络流量 | < 1MB/小时 | 监控 10 个 ETF |

#### 7.2 性能优化策略

##### UI 层优化
- **防抖更新**：Tooltip 更新间隔不低于 100ms
- **按需刷新**：仅在数据变化时更新 UI
- **虚拟列表**：详情窗口使用虚拟滚动（ETF > 100 时）
- **双缓冲**：避免闪烁

##### 网络层优化
- **连接池**：复用 HTTP 连接
  ```python
  client = httpx.Client(
      limits=httpx.Limits(max_keepalive_connections=5),
      timeout=5.0
  )
  ```
- **并发控制**：最多 10 个并发请求
- **请求合并**：尽可能批量请求（如接口支持）
- **缓存策略**：相同 ETF 5 秒内不重复请求

##### 数据层优化
- **内存缓存**：使用字典而非数据库（小规模数据）
- **惰性计算**：涨跌幅等字段按需计算
- **数据压缩**：历史数据启用压缩存储（未来功能）

##### 日志优化
- **异步写入**：使用 QueueHandler
- **日志轮转**：按天切分，保留 7 天
- **分级记录**：生产环境仅 INFO 及以上
  ```python
  logging.basicConfig(
      level=logging.INFO,
      handlers=[
          RotatingFileHandler('logs/app.log', maxBytes=10MB, backupCount=7)
      ]
  )
  ```

#### 7.3 性能监控

##### 内置性能指标
- 记录每次请求耗时
- 统计接口成功率
- 监控内存使用趋势

##### 性能日志示例
```
[2023-11-04 14:30:00] INFO - Data fetch completed in 1.2s (10 ETFs)
[2023-11-04 14:30:00] INFO - Memory usage: 65MB
[2023-11-04 14:30:05] WARNING - API response slow: 4.8s
```

### 8. 可靠性与容错

#### 8.1 异常恢复机制

##### 网络异常
```python
try:
    response = httpx.get(url, timeout=5)
except httpx.TimeoutException:
    logger.warning("Request timeout, retrying...")
    retry_with_backoff()
except httpx.NetworkError:
    logger.error("Network error, switching to backup API")
    switch_to_backup_api()
```

##### 数据异常
- **时间戳验证**：拒绝使用超过 5 分钟的旧数据
- **价格合理性**：检测涨跌幅是否超过 20%（可能数据错误）
- **字段完整性**：必填字段缺失时使用默认值

##### 程序崩溃
- **全局异常捕获**：记录 traceback
  ```python
  sys.excepthook = lambda *args: logger.exception("Uncaught exception")
  ```
- **自动重启**：崩溃后 5 秒自动重启（可选）
- **崩溃报告**：生成 crash dump

#### 8.2 数据校验规则

| 字段 | 验证规则 | 异常处理 |
|------|---------|---------|
| 价格 | > 0 且 < 1000 | 使用上次有效值 |
| 涨跌幅 | -20% ~ +20% | 记录告警，继续使用 |
| 时间戳 | 不早于 5 分钟前 | 拒绝使用，保留缓存 |
| 成交量 | >= 0 | 使用 0 代替负值 |

#### 8.3 日志记录规范

##### 日志级别定义
- **DEBUG**：详细的调试信息（开发模式）
- **INFO**：正常运行信息（启动、配置加载、数据刷新）
- **WARNING**：警告信息（请求慢、数据异常、接口切换）
- **ERROR**：错误信息（请求失败、解析错误）
- **CRITICAL**：严重错误（程序崩溃）

##### 关键日志示例
```python
# 启动
logger.info("ETF Monitor v1.0.0 started")
logger.info(f"Loaded {len(etf_list)} ETFs from config")

# 数据采集
logger.debug(f"Fetching quote for {code}")
logger.info(f"Updated {code}: {price} ({change_pct}%)")
logger.warning(f"API response time: {elapsed}s (threshold: 3s)")

# 异常
logger.error(f"Failed to fetch {code}: {error}")
logger.critical("Application crashed", exc_info=True)
```

##### 日志文件管理
```
logs/
  ├── etf_monitor.log           # 当前日志
  ├── etf_monitor.log.2023-11-04 # 历史日志
  ├── etf_monitor.log.2023-11-03
  └── ...                        # 保留 7 天
```

### 9. 安全性考虑

#### 9.1 数据安全
- **配置文件权限**：仅当前用户可读写
- **敏感信息**：不在日志中记录完整 URL（可能包含 token）
- **HTTPS**：尽可能使用加密连接

#### 9.2 代码安全
- **输入验证**：用户输入的 ETF 代码严格验证
- **SQL 注入防护**：虽然不用数据库，但防范未来扩展
- **路径遍历**：文件路径使用白名单

#### 9.3 隐私保护
- **本地运行**：所有数据处理在本地，不上传用户数据
- **网络请求**：仅向行情接口发送必要数据（ETF 代码）
- **无追踪**：不收集用户行为数据

### 10. 后续扩展方向

#### 短期扩展（MVP 之后）

##### 1. 涨跌幅告警
- 设置阈值（如 +3% 或 -3%）
- 触发时弹出 Windows 通知
- 可选：播放提示音
- 告警历史记录

##### 2. 支持股票代码
- 扩展到 A 股股票
- 支持港股、美股（需新接口）
- 统一数据模型

##### 3. 详情窗口增强
- 显示分时走势图（简单折线图）
- 显示当日最高/最低价
- 支持手动排序和过滤

#### 中期扩展

##### 1. WebSocket 实时推送
- 替代轮询，降低延迟
- 减少服务器压力
- 价格变化毫秒级响应

##### 2. 历史数据
- 缓存每日收盘价
- 绘制周/月涨跌趋势
- 导出 CSV 供分析

##### 3. 自定义显示
- Tooltip 显示模板
- 自定义颜色方案
- 字体大小调整

#### 长期扩展

##### 1. 云端同步
- 用户账号体系
- 多设备同步自选列表
- 云端备份配置

##### 2. 移动端配套
- 开发 Android/iOS App
- 数据实时同步
- 推送通知

##### 3. 高级功能
- 持仓盈亏计算
- 交易提醒
- 智能选股建议

### 11. 开发里程碑与时间规划

#### 第一阶段：架构设计（1 周）
- [x] 完善产品架构文档
- [x] 确定技术选型
- [ ] 设计数据模型
- [ ] 设计 UI 原型

#### 第二阶段：核心开发（3-4 周）
- [ ] 配置管理模块（2 天）
- [ ] 数据采集模块（5 天）
  - HTTP 客户端封装
  - 接口适配器
  - 主备切换逻辑
  - 缓存管理
- [ ] 系统托盘模块（3 天）
  - 托盘图标和菜单
  - Tooltip 轮播
  - 事件处理
- [ ] 设置界面模块（4 天）
  - ETF 列表管理
  - 参数配置
  - 数据验证
- [ ] 详情窗口（2 天，可选）
- [ ] 集成测试（3 天）

#### 第三阶段：打包发布（1 周）
- [ ] PyInstaller 打包配置（2 天）
- [ ] Inno Setup 安装包（2 天）
- [ ] 功能测试（2 天）
- [ ] 性能优化（1 天）

#### 第四阶段：发布与维护
- [ ] 发布 v1.0.0
- [ ] 收集用户反馈
- [ ] Bug 修复
- [ ] 功能迭代

---

## 附录

### A. 参考资料
- wxPython 官方文档：https://wxpython.org/
- PyInstaller 文档：https://pyinstaller.org/
- Inno Setup 文档：https://jrsoftware.org/isinfo.php
- 东方财富行情接口：（参考开发者社区）

### B. 相关文档
- `docs/config_schema.md` - 配置文件详细说明
- `docs/api_reference.md` - 接口文档（待创建）
- `docs/development_guide.md` - 开发指南（待创建）

### C. 常见问题
详见开发过程中的 FAQ 文档。

---

## 文档维护

- **创建日期**：2023-11-04
- **最后更新**：2023-11-04
- **文档版本**：1.0
- **维护者**：开发团队
